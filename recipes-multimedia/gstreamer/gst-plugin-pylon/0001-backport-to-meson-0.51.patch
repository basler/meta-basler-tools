From 37616ba58d3f1b13e54bd457c9e3063b0e4f8423 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=BCdiger=20K=C3=B6pke?= <Ruediger.Koepke@baslerweb.com>
Date: Wed, 4 Jan 2023 17:39:13 +0100
Subject: [PATCH] backport-to-meson-0.51

---
 gst-libs/gst/pylon/meson.build | 37 +++++++++++++++++-----------------
 meson.build                    |  2 +-
 2 files changed, 20 insertions(+), 19 deletions(-)

diff --git a/gst-libs/gst/pylon/meson.build b/gst-libs/gst/pylon/meson.build
index 44d3838..2837471 100644
--- a/gst-libs/gst/pylon/meson.build
+++ b/gst-libs/gst/pylon/meson.build
@@ -10,23 +10,23 @@ if target_machine.system() == 'linux' and pylon_path == 'PYLON_ROOT_NOT_SET'
   error('PYLON_ROOT has to be set to location of pylon install e.g. /opt/pylon')
 endif
 
-# detect pylon 7.x
-pylon_dep = dependency('pylon', method : 'cmake', modules : ['pylon::PylonBase', 'pylon::GCBase', 'pylon::GenApi', 'pylon::PylonUtility'],
-        version : '>=7.1', cmake_module_path: pylon_path / 'share/pylon/cmake/' , required: false)
-if pylon_dep.found()
-  # patch rpath on linux
-  if target_machine.system() == 'linux'
-    pylon_link_args = ['-Wl,--enable-new-dtags', '-Wl,-rpath,' + pylon_path / 'lib']
-  else
-    pylon_link_args = []
-  endif
-else
-    message('fallback to detect pylon 6.x')
-    pylon_dep = dependency('pylon', method : 'cmake', cmake_module_path: meson.project_source_root() + '/cmake', required: true)
-    # runtime path is properly defined by cmake
-    pylon_link_args = []
+pylon_config = find_program ('pylon-config', pylon_path / 'bin' / 'pylon-config', required : false, disabler : true)
+if not pylon_config.found()
+   error('Pylon SDK not found, is it installed? If you installed it in alternative location you may specify it using -Dpylon-path=')
 endif
 
+
+pylon_c_args = run_command(pylon_config, '--cflags', check : true).stdout().strip().split()
+pylon_link_args = run_command(pylon_config, '--libs', check : true).stdout().strip().split()
+
+pylon_dep = declare_dependency (
+    compile_args : pylon_c_args,
+    link_args : pylon_link_args
+)
+
+# runtime path is properly defined by cmake
+pylon_link_args = []
+
 gstpylon_sources = [
   'gstpylondebug.c',
   'gstpylonintrospection.cpp',
@@ -43,14 +43,15 @@ gstpylon_headers = [
 
 install_headers(gstpylon_headers, subdir : 'gstreamer-1.0/gst/pylon/')
 
-gstpylon = library('gstpylon-' + api_version,
+gstpylon = library('gstpylon-' +  api_version,
   gstpylon_sources,
-  c_args : gst_plugin_pylon_args + '-DBUILDING_EXT_PYLONSRC',
-  cpp_args : gst_plugin_pylon_args + '-DBUILDING_EXT_PYLONSRC',
+  c_args : gst_plugin_pylon_args + ['-DBUILDING_EXT_PYLONSRC',],
+  cpp_args : gst_plugin_pylon_args + ['-DBUILDING_EXT_PYLONSRC',],
   link_args : [noseh_link_args, pylon_link_args],
   include_directories : [configinc],
   dependencies : [gstbase_dep, gstvideo_dep, pylon_dep],
   install : true,
+  install_rpath: pylon_path / 'lib'
 )
 
 # generate pkgconfig file
diff --git a/meson.build b/meson.build
index af180d0..c88ec89 100644
--- a/meson.build
+++ b/meson.build
@@ -1,6 +1,6 @@
 project('gst-plugin-pylon', 'c', 'cpp',
   version : '0.5.1',
-  meson_version : '>= 0.61',
+  meson_version : '>= 0.51',
   default_options : [ 'warning_level=1',
                       'buildtype=debugoptimized' ])
 
-- 
2.34.1

